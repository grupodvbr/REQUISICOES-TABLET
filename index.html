<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Requisi√ß√µes Recebidas</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f4f4; margin: 0; padding: 10px; }
    header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
    header img { height: 40px; }
    header h1 { font-size: 1.4em; }
    .filtros { display: flex; flex-direction: column; gap: 8px; margin-bottom: 15px; }
    .filtros select, .filtros input { padding: 10px; font-size: 1em; border-radius: 6px; border: 1px solid #ccc; }
    .grupo { background: white; border-radius: 6px; margin-bottom: 20px; box-shadow: 0 1px 4px rgba(0,0,0,0.1); padding: 10px; }
    .grupo h3 { background: #007bff; color: white; margin: -10px -10px 10px; padding: 10px; border-radius: 6px 6px 0 0; }
    .item { border-bottom: 1px solid #eee; padding: 10px 0; display: flex; flex-direction: column; }
    .item strong { font-size: 1.1em; }
    .info { font-size: 0.9em; color: #555; }
    .botoes { margin-top: 5px; }
    .botoes button { padding: 8px 12px; margin-right: 10px; font-size: 1em; border: none; border-radius: 6px; cursor: pointer; }
    .btn-ok { background: #28a745; color: white; }
    .btn-nok { background: #dc3545; color: white; }
    #btnRelatorio { position: fixed; bottom: 15px; right: 15px; background: #007bff; color: white; border: none; padding: 12px 20px; font-size: 1em; border-radius: 6px; cursor: pointer; }
    #relatorioPDF { display: none; }
    .secao-relatorio { margin-bottom: 20px; }
    .secao-relatorio h2 { background: #007bff; color: white; padding: 8px; border-radius: 6px; margin-bottom: 10px; }
    .secao-relatorio ul { list-style: none; padding-left: 0; }
    .secao-relatorio li { padding: 5px 0; border-bottom: 1px solid #ccc; }
  </style>
</head>
<body>
  <header>
    <img src="https://static.wixstatic.com/media/d830b0_8cec50a98bbf4775814dbfa5386585e8~mv2.png" alt="Logo CB" />
    <h1>REQUISI√á√ïES RECEBIDAS</h1>
  </header>

  <div class="filtros">
    <input type="date" id="dataInicio" oninput="filtrar()" />
    <input type="date" id="dataFim" oninput="filtrar()" />
    <input type="text" id="busca" placeholder="üîç Buscar item ou observa√ß√£o" oninput="filtrar()" />
    <select id="statusFiltro" onchange="filtrar()">
      <option value="Processando">üìå Apenas Processando</option>
      <option value="">üìã Todos os Status</option>
      <option value="Entregue">‚úÖ Entregue</option>
      <option value="Faltou">‚ùå Faltou</option>
    </select>
    <select id="agruparPor" onchange="filtrar()">
      <option value="4">üë∑ Agrupar por Setor</option>
      <option value="5">üôã Agrupar por Solicitante</option>
    </select>
  </div>

  <div id="listaRequisicoes"></div>

  <button id="btnRelatorio" onclick="gerarRelatorioPDF()">üìÑ Gerar Relat√≥rio</button>

  <div id="relatorioPDF">
    <header style="display:flex;align-items:center;gap:10px;margin-bottom:20px">
      <img src="https://static.wixstatic.com/media/d830b0_8cec50a98bbf4775814dbfa5386585e8~mv2.png" style="height:40px" />
      <h1 style="font-size:1.4em;">üìÑ Relat√≥rio de Requisi√ß√µes</h1>
    </header>
    <div class="secao-relatorio" id="relatorioEntregues">
      <h2>‚úÖ ENTREGUES</h2>
    </div>
    <div class="secao-relatorio" id="relatorioFaltou">
      <h2>‚ùå FALTOU</h2>
    </div>
  </div>

  <script>
    let requisicoes = [];
    let entregues = JSON.parse(localStorage.getItem("entregues")) || [];
    let faltaram = JSON.parse(localStorage.getItem("faltaram")) || [];

    async function carregar() {
      const res = await fetch("https://script.google.com/macros/s/AKfycbxU6j4unKVkkPgePAP4KuI0ojp7EA67ayEkG16LPZdXDf3J-V2jlnXQe9Z4og1KaAIASg/exec");
      requisicoes = await res.json();
      filtrar();
    }

    function gerarRelatorioPDF() {
      const inicio = document.getElementById("dataInicio").value;
      const fim = document.getElementById("dataFim").value;
      const busca = document.getElementById("busca").value.toLowerCase();
      const statusFiltro = document.getElementById("statusFiltro").value;

      const entreguesDiv = document.getElementById("relatorioEntregues");
      const faltouDiv = document.getElementById("relatorioFaltou");
      entreguesDiv.innerHTML = "<h2>‚úÖ ENTREGUES</h2>";
      faltouDiv.innerHTML = "<h2>‚ùå FALTOU</h2>";

      const filtradas = requisicoes.filter(l => {
        const dataHora = new Date(l[0]);
        const statusAtual = l[7] || "";
        if (inicio && dataHora < new Date(inicio + "T00:00")) return false;
        if (fim && dataHora > new Date(fim + "T23:59")) return false;
        if (busca && !l[1].toLowerCase().includes(busca) && !l[6].toLowerCase().includes(busca)) return false;
        if (statusFiltro === "Processando" && statusAtual !== "") return false;
        if (statusFiltro && statusFiltro !== "Processando" && statusAtual !== statusFiltro) return false;
        return true;
      });

      const grupoEntregues = {};
      const grupoFaltou = {};

      entregues.forEach(e => {
        const item = filtradas.find(f => f[0] === e.dataHora && f[1] === e.item);
        if (!item) return;
        const setor = item[4] || "Sem Setor";
        if (!grupoEntregues[setor]) grupoEntregues[setor] = [];
        grupoEntregues[setor].push({ ...e, data: item[0], solicitante: item[5], obs: item[6] });
      });

      faltaram.forEach(f => {
        const item = filtradas.find(d => d[0] === f.dataHora && d[1] === f.item);
        if (!item) return;
        const setor = item[4] || "Sem Setor";
        if (!grupoFaltou[setor]) grupoFaltou[setor] = [];
        grupoFaltou[setor].push({ ...f, data: item[0], solicitante: item[5], obs: item[6] });
      });

      for (const setor in grupoEntregues) {
        const bloco = document.createElement("div");
        bloco.innerHTML = `<h3 style="margin:10px 0;">üîπ ${setor}</h3>`;
        const lista = document.createElement("ul");
        grupoEntregues[setor].forEach(e => {
          const li = document.createElement("li");
          li.textContent = `‚Ä¢ ${e.item} ‚Äî ${e.qtd} unidades ‚Äî ${new Date(e.data).toLocaleString('pt-BR')} ‚Äî ${e.solicitante} ‚Äî ${e.obs}`;
          lista.appendChild(li);
        });
        bloco.appendChild(lista);
        entreguesDiv.appendChild(bloco);
      }

      for (const setor in grupoFaltou) {
        const bloco = document.createElement("div");
        bloco.innerHTML = `<h3 style="margin:10px 0;">üî∏ ${setor}</h3>`;
        const lista = document.createElement("ul");
        grupoFaltou[setor].forEach(f => {
          const li = document.createElement("li");
          li.textContent = `‚Ä¢ ${f.item} ‚Äî ${new Date(f.data).toLocaleString('pt-BR')} ‚Äî ${f.solicitante} ‚Äî ${f.obs}`;
          lista.appendChild(li);
        });
        bloco.appendChild(lista);
        faltouDiv.appendChild(bloco);
      }

      const opt = {
        margin: 0.5,
        filename: 'relatorio_requisicoes.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'cm', format: 'a4', orientation: 'portrait' }
      };

      html2pdf().set(opt).from(document.getElementById("relatorioPDF")).save();
    }

    window.onload = () => {
      document.getElementById("statusFiltro").value = "Processando";
      carregar();
    };
  </script>
</body>
</html>
