<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Requisições Recebidas</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f4;
      margin: 0;
      padding: 10px;
    }
    header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }
    header img {
      height: 40px;
    }
    header h1 {
      font-size: 1.4em;
    }
    .filtros {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 15px;
    }
    .filtros select, .filtros input {
      padding: 10px;
      font-size: 1em;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    .grupo {
      background: white;
      border-radius: 6px;
      margin-bottom: 20px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
      padding: 10px;
    }
    .grupo h3 {
      background: #007bff;
      color: white;
      margin: -10px -10px 10px;
      padding: 10px;
      border-radius: 6px 6px 0 0;
    }
    .item {
      border-bottom: 1px solid #eee;
      padding: 10px 0;
      display: flex;
      flex-direction: column;
    }
    .item strong {
      font-size: 1.1em;
    }
    .info {
      font-size: 0.9em;
      color: #555;
    }
    .botoes {
      margin-top: 5px;
    }
    .botoes button {
      padding: 8px 12px;
      margin-right: 10px;
      font-size: 1em;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    .btn-ok {
      background: #28a745;
      color: white;
    }
    .btn-nok {
      background: #dc3545;
      color: white;
    }
  </style>
</head>
<body>
  <header>
    <img src="https://raw.githubusercontent.com/grupodvbr/REQUISICOES-TABLET/main/logo-cb.png" alt="Logo CB" />
    <h1>REQUISIÇÕES RECEBIDAS</h1>
  </header>

  <div class="filtros">
    <input type="date" id="dataInicio" />
    <input type="date" id="dataFim" />
    <input type="text" id="busca" placeholder="🔍 Buscar item ou observação" />
    <select id="statusFiltro">
      <option value="Processando">📌 Apenas Processando</option>
      <option value="">📋 Todos os Status</option>
      <option value="Entregue">✅ Entregue</option>
      <option value="Faltou">❌ Faltou</option>
    </select>
    <select id="agruparPor">
      <option value="4">👷 Agrupar por Setor</option>
      <option value="5">🙋 Agrupar por Solicitante</option>
    </select>
  </div>

  <div id="listaRequisicoes"></div>

  <script>
    let requisicoes = [];

    async function carregar() {
      const res = await fetch("https://script.google.com/macros/s/AKfycbxU6j4unKVkkPgePAP4KuI0ojp7EA67ayEkG16LPZdXDf3J-V2jlnXQe9Z4og1KaAIASg/exec");
      const dados = await res.json();
      requisicoes = dados;
      filtrar();
    }

    function filtrar() {
      const inicio = document.getElementById("dataInicio").value;
      const fim = document.getElementById("dataFim").value;
      const busca = document.getElementById("busca").value.toLowerCase();
      const status = document.getElementById("statusFiltro").value;
      const campoAgrupar = document.getElementById("agruparPor").value;

      const filtradas = requisicoes.filter(l => {
        const dataHora = new Date(l[0]);
        if (inicio && dataHora < new Date(inicio + "T00:00")) return false;
        if (fim && dataHora > new Date(fim + "T23:59")) return false;
        if (busca && !l[1].toLowerCase().includes(busca) && !l[6].toLowerCase().includes(busca)) return false;
        if (status && l[7] !== status) return false;
        return true;
      });

      const agrupado = {};
      filtradas.forEach(l => {
        const chave = l[campoAgrupar];
        if (!agrupado[chave]) agrupado[chave] = [];
        agrupado[chave].push(l);
      });

      const container = document.getElementById("listaRequisicoes");
      container.innerHTML = '';

      for (const grupo in agrupado) {
        const divGrupo = document.createElement("div");
        divGrupo.className = "grupo";
        divGrupo.innerHTML = `<h3>${grupo}</h3>`;

        agrupado[grupo].forEach(l => {
          const div = document.createElement("div");
          div.className = "item";
          div.innerHTML = `
            <strong>${l[1]} — ${l[3]} ${l[2]}</strong>
            <div class="info">📅 ${new Date(l[0]).toLocaleString('pt-BR')}</div>
            <div class="info">🙋 ${l[5]}</div>
            <div class="info">📝 ${l[6]}</div>
            <div class="info">📌 Status: ${l[7]}</div>
            <div class="botoes">
              <button class="btn-ok" onclick="atualizarStatus('${l[0]}', '${l[1]}', 'Entregue')">✅ Entregue</button>
              <button class="btn-nok" onclick="atualizarStatus('${l[0]}', '${l[1]}', 'Faltou')">❌ Faltou</button>
            </div>
          `;
          divGrupo.appendChild(div);
        });

        container.appendChild(divGrupo);
      }
    }

    async function atualizarStatus(dataHora, item, novoStatus) {
      let quantidadeEntregue = "";

      if (novoStatus === "Entregue") {
        quantidadeEntregue = prompt("Informe a quantidade entregue:");
        if (!quantidadeEntregue) return alert("Operação cancelada.");
      }

      if (novoStatus === "Faltou") {
        const confirmar = confirm(`Tem certeza que deseja marcar o item "${item}" como FALTOU?`);
        if (!confirmar) return;
      }

      const payload = {
        dataHora,
        item,
        novoStatus,
        quantidadeEntregue
      };

      await fetch("https://script.google.com/macros/s/AKfycbxU6j4unKVkkPgePAP4KuI0ojp7EA67ayEkG16LPZdXDf3J-V2jlnXQe9Z4og1KaAIASg/exec", {
        method: 'POST',
        body: JSON.stringify(payload),
        headers: { "Content-Type": "application/json" }
      });

      alert(`Status atualizado para "${novoStatus}"`);
      carregar();
    }

    window.onload = () => {
      document.getElementById("statusFiltro").value = "Processando";
      carregar();
    }
  </script>
</body>
</html>
