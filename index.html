<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Requisi√ß√µes Tablet</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f9f9f9;
      margin: 0;
      padding: 10px;
    }
    h1 {
      text-align: center;
      font-size: 1.6em;
      margin-bottom: 10px;
    }
    .filtros {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 15px;
    }
    .filtros select,
    .filtros input {
      padding: 10px;
      font-size: 1em;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    .grupo {
      background: white;
      border-radius: 6px;
      margin-bottom: 20px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
      padding: 10px;
    }
    .grupo h3 {
      background: #007bff;
      color: white;
      margin: -10px -10px 10px;
      padding: 10px;
      border-radius: 6px 6px 0 0;
    }
    .item {
      border-bottom: 1px solid #eee;
      padding: 10px 0;
      display: flex;
      flex-direction: column;
    }
    .item strong {
      font-size: 1.1em;
    }
    .info {
      font-size: 0.9em;
      color: #555;
    }
    .botoes {
      margin-top: 5px;
    }
    .botoes button {
      padding: 8px 12px;
      margin-right: 10px;
      font-size: 1em;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    .btn-ok {
      background: #28a745;
      color: white;
    }
    .btn-nok {
      background: #dc3545;
      color: white;
    }
  </style>
</head>
<body>
  <h1>üìã Requisi√ß√µes</h1>

  <div class="filtros">
    <input type="date" id="dataInicio" />
    <input type="date" id="dataFim" />
    <input type="text" id="busca" placeholder="üîç Buscar item ou observa√ß√£o" />
    <select id="filtroStatus" onchange="filtrar()">
      <option value="PROCESSANDO" selected>PROCESSANDO</option>
      <option value="Entregue">ENTREGUE</option>
      <option value="Faltou">FALTOU</option>
      <option value="todos">TODOS</option>
    </select>
    <select id="filtroAgrupamento" onchange="filtrar()">
      <option value="setor" selected>Agrupar por Setor</option>
      <option value="solicitante">Agrupar por Solicitante</option>
    </select>
  </div>

  <div id="listaRequisicoes"></div>

  <script>
    let requisicoes = [];

    async function carregar() {
      const res = await fetch("https://script.google.com/macros/s/AKfycbxw1XO5_8_inzujBxlfbLeJkRUj_RpXBb8BeVAhP2J3XHMaQoynPDRm-P7Erpu3BpSa_g/exec");
      const dados = await res.json();
      requisicoes = dados.map(l => l.map(c => (c || '').toString().trim()));
      filtrar();
    }

    function filtrar() {
      const inicio = document.getElementById("dataInicio").value;
      const fim = document.getElementById("dataFim").value;
      const busca = document.getElementById("busca").value.toLowerCase();
      const filtroStatus = document.getElementById("filtroStatus").value;
      const agruparPor = document.getElementById("filtroAgrupamento").value;

      const filtradas = requisicoes.filter(l => {
        const dataHora = new Date(l[0]);
        const statusAtual = (l[7] || "PROCESSANDO").toUpperCase();

        if (filtroStatus !== "todos" && statusAtual !== filtroStatus.toUpperCase()) return false;
        if (inicio && dataHora < new Date(inicio + "T00:00")) return false;
        if (fim && dataHora > new Date(fim + "T23:59")) return false;
        if (busca && !l[1].toLowerCase().includes(busca) && !l[6].toLowerCase().includes(busca)) return false;
        return true;
      });

      const agrupado = {};
      filtradas.forEach(l => {
        const chave = agruparPor === 'solicitante' ? l[5] : l[4];
        if (!agrupado[chave]) agrupado[chave] = [];
        agrupado[chave].push(l);
      });

      const container = document.getElementById("listaRequisicoes");
      container.innerHTML = '';

      for (const grupo in agrupado) {
        const grupoDiv = document.createElement("div");
        grupoDiv.className = "grupo";
        grupoDiv.innerHTML = `<h3>${grupo}</h3>`;

        agrupado[grupo].forEach(l => {
          const div = document.createElement("div");
          div.className = "item";
          div.innerHTML = `
            <strong>${l[1]} ‚Äî ${l[3]} ${l[2]}</strong>
            <div class="info">üìÖ ${new Date(l[0]).toLocaleString('pt-BR')}</div>
            <div class="info">üôã ${l[5]}</div>
            <div class="info">üìù ${l[6]}</div>
            <div class="info">üìå Status: ${l[7]}</div>
            <div class="botoes">
              <button class="btn-ok" onclick="atualizarStatus('${l[0]}', '${l[1]}', 'Entregue')">‚úÖ Entregue</button>
              <button class="btn-nok" onclick="atualizarStatus('${l[0]}', '${l[1]}', 'Faltou')">‚ùå Faltou</button>
            </div>
          `;
          grupoDiv.appendChild(div);
        });

        container.appendChild(grupoDiv);
      }
    }

    async function atualizarStatus(dataHora, item, novoStatus) {
      let quantidadeEntregue = "";

      if (novoStatus === "Entregue") {
        quantidadeEntregue = prompt("Informe a quantidade entregue:");
        if (!quantidadeEntregue) return alert("Opera√ß√£o cancelada.");
      }

      const payload = {
        dataHora,
        item,
        novoStatus,
        quantidadeEntregue
      };

      await fetch("https://script.google.com/macros/s/AKfycbxw1XO5_8_inzujBxlfbLeJkRUj_RpXBb8BeVAhP2J3XHMaQoynPDRm-P7Erpu3BpSa_g/exec", {
        method: 'POST',
        body: JSON.stringify(payload),
        headers: { "Content-Type": "application/json" }
      });

      alert(`Status atualizado para "${novoStatus}"`);
      carregar();
    }

    carregar();
  </script>
</body>
</html>
